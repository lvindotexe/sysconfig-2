---
- name: Download latest nVim release
  ansible.builtin.get_url:
    url: 'https://github.com/neovim/neovim/releases/latest/download/nvim-linux64.tar.gz'
    dest: /tmp/nvim-linux64.tar.gz
    owner: root
    mode: '0755'
  register: nvim_release

- name: Make sure that we start clean
  ansible.builtin.file:
    path: '/tmp/nvim-linux64'
    state: absent

- name: Unpack nVim release
  ansible.builtin.unarchive:
    src: /tmp/nvim-linux64.tar.gz
    dest: /tmp/
    creates: '/tmp/nvim-linux64'
    remote_src: yes

- name: Clean-up previous nVim install
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /usr/bin/nvim
    - /usr/lib/nvim/
    - /usr/share/nvim/
    - /usr/share/applications/nvim.desktop
    - /usr/share/icons/hicolor/128x128/apps/nvim.png
    - /usr/share/locale/en_GB/LC_MESSAGES/nvim.mo
    - /usr/share/man/man1/nvim.1

- name: Install latest nVim release
  ansible.builtin.copy:
    src: "/tmp/nvim-linux64/{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: "{{ item.mode }}"
    owner: root
    remote_src: yes
    force: yes
  loop:
    - { src: 'bin/nvim', dest: '/usr/bin/nvim', mode: '0755'}
    - { src: 'lib/nvim/parser', dest: '/usr/lib/nvim/', mode: '0755'}
    - { src: 'share/man/man1/nvim.1', dest: '/usr/share/man/man1/', mode: '0644'}
    - { src: 'share/applications/nvim.desktop', dest: '/usr/share/applications/', mode: '0644'}
    - { src: 'share/icons/hicolor/128x128/apps/nvim.png', dest: '/usr/share/icons/hicolor/128x128/apps/', mode: '0644'}
    - { src: 'share/locale/en_GB/LC_MESSAGES/nvim.mo', dest: '/usr/share/locale/en_GB/LC_MESSAGES/', mode: '0644'}
    - { src: 'share/nvim/runtime', dest: '/usr/share/nvim/', mode: '0755'}
  notify:
    - update_mandb
    - update_locales

- name: Update default editor, use nVim for everything
  ansible.builtin.command:
    cmd: "{{ item }}"
  become: yes
  loop:
    - 'update-alternatives --install /usr/bin/editor editor /usr/bin/nvim 1'
    - 'update-alternatives --install /usr/bin/vi vi /usr/bin/nvim 1'
    - 'update-alternatives --install /usr/bin/vim vim /usr/bin/nvim 1'
    - 'update-alternatives --set editor /usr/bin/nvim'
    - 'update-alternatives --set vi /usr/bin/nvim'
    - 'update-alternatives --set vim /usr/bin/nvim'